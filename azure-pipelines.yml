trigger:
  branches:
    include:
      - FrontalSuma

pr:
  branches:
    include:
      - FrontalSuma

variables:
  azureServiceConnection: 'LabsConn'
  resourceGroup: 'AHL_resources'
  aksClusterName: 'KSuma'
  acrName: 'acrsuma'
  acrLoginServer: 'acrsuma.azurecr.io'
  trivyImageFailSeverities: 'CRITICAL'
  trivyConfigFailSeverities: 'HIGH,CRITICAL'
  ghcrPat: ''
  keyVaultName: 'AHLSecretos'
  ghcrUser: 'lhalha01'
  namespace: 'calculadora-suma'
  terraformWorkingDir: 'infra/terraform'
  sonarOrganization: 'lhalha01'
  sonarProjectKey: 'lhalha01_SumaBasicaDocker'
  sonarProjectName: 'SumaBasicaDocker'

stages:
  - stage: TerraformPlan
    displayName: 'Terraform Plan'
    jobs:
      - job: Plan
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self

          - task: Bash@3
            displayName: 'Install Terraform 1.6.6'
            inputs:
              targetType: 'inline'
              script: |
                set -euo pipefail
                curl -fsSL -o terraform.zip https://releases.hashicorp.com/terraform/1.6.6/terraform_1.6.6_linux_amd64.zip
                unzip -o terraform.zip
                sudo mv terraform /usr/local/bin/terraform
                terraform version

          - task: AzureCLI@2
            displayName: 'Terraform init/validate/plan'
            inputs:
              azureSubscription: '$(azureServiceConnection)'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                set -euo pipefail
                cd "$(terraformWorkingDir)"
                terraform init
                terraform validate
                terraform plan \
                  -var="resource_group_name=$(resourceGroup)" \
                  -var="existing_aks_name=$(aksClusterName)" \
                  -var="kubelet_identity_object_id=$(AKS_KUBELET_OBJECT_ID)"

  - stage: CodeQuality
    displayName: 'SonarCloud Code Quality'
    dependsOn: TerraformPlan
    jobs:
      - job: SonarAnalysis
        displayName: 'SonarCloud static analysis'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self
            fetchDepth: 0

          - task: Bash@3
            displayName: 'Run SonarCloud analysis (CLI)'
            env:
              SONAR_TOKEN: $(SONAR_TOKEN)
              SONAR_ORGANIZATION: $(sonarOrganization)
              SONAR_PROJECT_KEY: $(sonarProjectKey)
              SONAR_PROJECT_NAME: $(sonarProjectName)
            inputs:
              targetType: 'inline'
              script: |
                set -euo pipefail

                SCANNER_VERSION="6.2.1.4610"
                curl -fsSL -o sonar-scanner.zip \
                  "https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-${SCANNER_VERSION}-linux-x64.zip"
                unzip -q sonar-scanner.zip
                export PATH="$PWD/sonar-scanner-${SCANNER_VERSION}-linux-x64/bin:$PATH"

                sonar-scanner \
                  -Dsonar.host.url=https://sonarcloud.io \
                  -Dsonar.token="$SONAR_TOKEN" \
                  -Dsonar.organization="$SONAR_ORGANIZATION" \
                  -Dsonar.projectKey="$SONAR_PROJECT_KEY" \
                  -Dsonar.projectName="$SONAR_PROJECT_NAME" \
                  -Dsonar.sources=. \
                  -Dsonar.exclusions="**/__pycache__/**,**/trivy-reports/**,infra/**,k8s/**" \
                  -Dsonar.python.version=3.11 \
                  -Dsonar.qualitygate.wait=true

  - stage: BuildAndPush
    displayName: 'Build and Push Proxy Image'
    dependsOn: CodeQuality
    jobs:
      - job: BuildPush
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self

          - task: AzureCLI@2
            displayName: 'Build and push to ACR'
            inputs:
              azureSubscription: '$(azureServiceConnection)'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                set -euo pipefail
                ACR_NAME="$(acrName)"
                ACR_LOGIN_SERVER="$(acrLoginServer)"

                if [ -z "$ACR_NAME" ]; then
                  ACR_NAME=$(az acr list -g "$(resourceGroup)" --query "[0].name" -o tsv)
                fi

                if [ -z "$ACR_NAME" ]; then
                  ACR_TOTAL=$(az acr list --query "length(@)" -o tsv)
                  if [ "$ACR_TOTAL" = "1" ]; then
                    ACR_NAME=$(az acr list --query "[0].name" -o tsv)
                  elif [ "$ACR_TOTAL" = "0" ]; then
                    echo "ERROR: No se encontró ningún ACR en la suscripción. Crea uno o define 'acrName'."
                    exit 1
                  else
                    echo "ERROR: Se encontraron múltiples ACR en la suscripción y ninguno en $(resourceGroup). Define 'acrName'."
                    az acr list --query "[].{name:name,resourceGroup:resourceGroup,loginServer:loginServer}" -o table
                    exit 1
                  fi
                fi

                if [ -z "$ACR_NAME" ]; then
                  echo "ERROR: No se encontró ACR en el resource group $(resourceGroup). Define 'acrName'."
                  exit 1
                fi

                if [ -z "$ACR_LOGIN_SERVER" ]; then
                  ACR_LOGIN_SERVER=$(az acr show -n "$ACR_NAME" --query loginServer -o tsv)
                fi

                if [ -z "$ACR_LOGIN_SERVER" ]; then
                  echo "ERROR: No se pudo resolver loginServer para ACR '$ACR_NAME'. Define 'acrLoginServer'."
                  exit 1
                fi

                echo "##vso[task.setvariable variable=acrName]$ACR_NAME"
                echo "##vso[task.setvariable variable=acrLoginServer]$ACR_LOGIN_SERVER"

                az acr login --name "$ACR_NAME"
                IMAGE="$ACR_LOGIN_SERVER/suma-proxy:$(Build.SourceVersion)"
                docker build -t "$IMAGE" .
                docker push "$IMAGE"
                docker tag "$IMAGE" "$ACR_LOGIN_SERVER/suma-proxy:latest"
                docker push "$ACR_LOGIN_SERVER/suma-proxy:latest"

                echo "##vso[task.setvariable variable=proxyImage;isOutput=true]$IMAGE"
            name: buildMeta

  - stage: SecurityScan
    displayName: 'Trivy Security Scan'
    dependsOn: BuildAndPush
    jobs:
      - job: TrivyImageScan
        displayName: 'Scan image with Trivy'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self

          - task: AzureCLI@2
            displayName: 'Install Trivy and pull image'
            inputs:
              azureSubscription: '$(azureServiceConnection)'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                set -euo pipefail

                ACR_NAME="$(acrName)"
                ACR_LOGIN_SERVER="$(acrLoginServer)"

                if [ -z "$ACR_NAME" ]; then
                  ACR_NAME=$(az acr list -g "$(resourceGroup)" --query "[0].name" -o tsv)
                fi

                if [ -z "$ACR_NAME" ]; then
                  ACR_TOTAL=$(az acr list --query "length(@)" -o tsv)
                  if [ "$ACR_TOTAL" = "1" ]; then
                    ACR_NAME=$(az acr list --query "[0].name" -o tsv)
                  elif [ "$ACR_TOTAL" = "0" ]; then
                    echo "ERROR: No se encontró ningún ACR en la suscripción. Crea uno o define 'acrName'."
                    exit 1
                  else
                    echo "ERROR: Se encontraron múltiples ACR en la suscripción y ninguno en $(resourceGroup). Define 'acrName'."
                    az acr list --query "[].{name:name,resourceGroup:resourceGroup,loginServer:loginServer}" -o table
                    exit 1
                  fi
                fi

                if [ -z "$ACR_LOGIN_SERVER" ]; then
                  ACR_LOGIN_SERVER=$(az acr show -n "$ACR_NAME" --query loginServer -o tsv)
                fi

                if [ -z "$ACR_LOGIN_SERVER" ]; then
                  echo "ERROR: No se pudo resolver loginServer para ACR '$ACR_NAME'. Define 'acrLoginServer'."
                  exit 1
                fi

                az acr login --name "$ACR_NAME"

                TRIVY_VERSION="0.57.1"
                curl -sfL "https://github.com/aquasecurity/trivy/releases/download/v${TRIVY_VERSION}/trivy_${TRIVY_VERSION}_Linux-64bit.tar.gz" -o trivy.tar.gz
                tar -xzf trivy.tar.gz trivy
                sudo mv trivy /usr/local/bin/trivy
                trivy --version

                IMAGE="$ACR_LOGIN_SERVER/suma-proxy:$(Build.SourceVersion)"
                docker pull "$IMAGE"

          - task: Bash@3
            displayName: 'Generate Trivy reports (JSON/SARIF)'
            inputs:
              targetType: 'inline'
              script: |
                set -euo pipefail
                IMAGE="$(acrLoginServer)/suma-proxy:$(Build.SourceVersion)"
                mkdir -p trivy-reports

                trivy image \
                  --severity "$(trivyImageFailSeverities)" \
                  --skip-files /usr/local/bin/kubectl \
                  --ignore-unfixed \
                  --exit-code 0 \
                  --no-progress \
                  --format json \
                  --output trivy-reports/trivy-report.json \
                  "$IMAGE"

                trivy image \
                  --severity "$(trivyImageFailSeverities)" \
                  --skip-files /usr/local/bin/kubectl \
                  --ignore-unfixed \
                  --exit-code 0 \
                  --no-progress \
                  --format sarif \
                  --output trivy-reports/trivy-report.sarif \
                  "$IMAGE"

                trivy config \
                  --severity "$(trivyConfigFailSeverities)" \
                  --exit-code 0 \
                  --skip-dirs trivy-reports \
                  --quiet \
                  --format json \
                  --output trivy-reports/trivy-config-report.json \
                  .

                trivy config \
                  --severity "$(trivyConfigFailSeverities)" \
                  --exit-code 0 \
                  --skip-dirs trivy-reports \
                  --quiet \
                  --format sarif \
                  --output trivy-reports/trivy-config-report.sarif \
                  .

          - task: PublishPipelineArtifact@1
            displayName: 'Publish Trivy reports'
            condition: always()
            inputs:
              targetPath: '$(System.DefaultWorkingDirectory)/trivy-reports'
              artifact: 'trivy-reports'
              publishLocation: 'pipeline'

          - task: Bash@3
            displayName: 'Trivy security gate'
            inputs:
              targetType: 'inline'
              script: |
                set -euo pipefail
                IMAGE="$(acrLoginServer)/suma-proxy:$(Build.SourceVersion)"

                trivy image \
                  --severity "$(trivyImageFailSeverities)" \
                  --skip-files /usr/local/bin/kubectl \
                  --ignore-unfixed \
                  --exit-code 1 \
                  --no-progress \
                  "$IMAGE"

                trivy config \
                  --severity "$(trivyConfigFailSeverities)" \
                  --exit-code 1 \
                  --skip-dirs trivy-reports \
                  --quiet \
                  .

  - stage: DeployAKS
    displayName: 'Deploy to AKS'
    dependsOn: SecurityScan
    jobs:
      - deployment: Deploy
        environment: 'aks-frontal'
        pool:
          vmImage: 'ubuntu-latest'
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self

                - task: AzureCLI@2
                  displayName: 'AKS deploy workloads'
                  inputs:
                    azureSubscription: '$(azureServiceConnection)'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      set -euo pipefail

                      ACR_LOGIN_SERVER="$(acrLoginServer)"

                      if [ -z "$ACR_LOGIN_SERVER" ]; then
                        ACR_NAME="$(acrName)"
                        if [ -z "$ACR_NAME" ]; then
                          ACR_NAME=$(az acr list -g "$(resourceGroup)" --query "[0].name" -o tsv)
                        fi

                        if [ -z "$ACR_NAME" ]; then
                          ACR_TOTAL=$(az acr list --query "length(@)" -o tsv)
                          if [ "$ACR_TOTAL" = "1" ]; then
                            ACR_NAME=$(az acr list --query "[0].name" -o tsv)
                          elif [ "$ACR_TOTAL" = "0" ]; then
                            echo "ERROR: No se encontró ningún ACR en la suscripción. Crea uno o define 'acrName'."
                            exit 1
                          else
                            echo "ERROR: Se encontraron múltiples ACR en la suscripción y ninguno en $(resourceGroup). Define 'acrName'."
                            az acr list --query "[].{name:name,resourceGroup:resourceGroup,loginServer:loginServer}" -o table
                            exit 1
                          fi
                        fi

                        if [ -z "$ACR_NAME" ]; then
                          echo "ERROR: No se encontró ACR en el resource group $(resourceGroup). Define 'acrName'."
                          exit 1
                        fi

                        ACR_LOGIN_SERVER=$(az acr show -n "$ACR_NAME" --query loginServer -o tsv)
                      fi

                      if [ -z "$ACR_LOGIN_SERVER" ]; then
                        echo "ERROR: No se pudo resolver 'acrLoginServer'."
                        exit 1
                      fi

                      az aks get-credentials -g "$(resourceGroup)" -n "$(aksClusterName)" --overwrite-existing

                      GHCR_PAT="$(ghcrPat)"

                      if [ -z "$GHCR_PAT" ]; then
                        GHCR_PAT=$(az keyvault secret show \
                          --vault-name "$(keyVaultName)" \
                          --name "github-pat" \
                          --query value -o tsv 2>/dev/null || true)
                      fi

                      if [ -z "$GHCR_PAT" ]; then
                        echo "ERROR: No se pudo obtener github-pat. Define variable secreta 'ghcrPat' en la pipeline o da permisos de secretos al service principal sobre Key Vault $(keyVaultName)."
                        exit 1
                      fi

                      kubectl apply -f k8s/namespace.yaml

                      kubectl create secret docker-registry ghcr-secret \
                        --namespace "$(namespace)" \
                        --docker-server=ghcr.io \
                        --docker-username="$(ghcrUser)" \
                        --docker-password="$GHCR_PAT" \
                        --dry-run=client -o yaml | kubectl apply -f -

                      kubectl apply -f k8s/backend-workloads.yaml
                      kubectl apply -f k8s/proxy-rbac.yaml

                      IMAGE="$ACR_LOGIN_SERVER/suma-proxy:$(Build.SourceVersion)"
                      sed "s|__PROXY_IMAGE__|$IMAGE|g" k8s/proxy-deployment.yaml | kubectl apply -f -
                      kubectl apply -f k8s/proxy-service.yaml

                      kubectl rollout status deployment/suma-proxy -n "$(namespace)" --timeout=300s
                      kubectl get deployments,services,pods -n "$(namespace)"
