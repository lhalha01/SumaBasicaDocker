trigger:
  branches:
    include:
      - FrontalSuma

pr:
  branches:
    include:
      - FrontalSuma
      - ConHelm
      - master

variables:
  azureServiceConnection: 'LabsConn'
  resourceGroup: 'AHL_resources'
  aksClusterName: 'KSuma'
  acrName: 'acrsuma'
  acrLoginServer: 'acrsuma.azurecr.io'
  ghcrPat: ''
  keyVaultName: 'AHLSecretos'
  ghcrUser: 'lhalha01'
  namespace: 'calculadora-suma'
  terraformWorkingDir: 'infra/terraform'

stages:
  - stage: TerraformPlan
    displayName: 'Terraform Plan'
    jobs:
      - job: Plan
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self

          - task: Bash@3
            displayName: 'Install Terraform 1.6.6'
            inputs:
              targetType: 'inline'
              script: |
                set -euo pipefail
                curl -fsSL -o terraform.zip https://releases.hashicorp.com/terraform/1.6.6/terraform_1.6.6_linux_amd64.zip
                unzip -o terraform.zip
                sudo mv terraform /usr/local/bin/terraform
                terraform version

          - task: AzureCLI@2
            displayName: 'Terraform init/validate/plan'
            inputs:
              azureSubscription: '$(azureServiceConnection)'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                set -euo pipefail
                cd "$(terraformWorkingDir)"
                terraform init
                terraform validate
                terraform plan \
                  -var="resource_group_name=$(resourceGroup)" \
                  -var="existing_aks_name=$(aksClusterName)" \
                  -var="kubelet_identity_object_id=$(AKS_KUBELET_OBJECT_ID)"

  - stage: BuildAndPush
    displayName: 'Build and Push Proxy Image'
    dependsOn: TerraformPlan
    jobs:
      - job: BuildPush
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self

          - task: AzureCLI@2
            displayName: 'Build and push to ACR'
            inputs:
              azureSubscription: '$(azureServiceConnection)'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                set -euo pipefail
                ACR_NAME="$(acrName)"
                ACR_LOGIN_SERVER="$(acrLoginServer)"

                if [ -z "$ACR_NAME" ]; then
                  ACR_NAME=$(az acr list -g "$(resourceGroup)" --query "[0].name" -o tsv)
                fi

                if [ -z "$ACR_NAME" ]; then
                  ACR_TOTAL=$(az acr list --query "length(@)" -o tsv)
                  if [ "$ACR_TOTAL" = "1" ]; then
                    ACR_NAME=$(az acr list --query "[0].name" -o tsv)
                  elif [ "$ACR_TOTAL" = "0" ]; then
                    echo "ERROR: No se encontró ningún ACR en la suscripción. Crea uno o define 'acrName'."
                    exit 1
                  else
                    echo "ERROR: Se encontraron múltiples ACR en la suscripción y ninguno en $(resourceGroup). Define 'acrName'."
                    az acr list --query "[].{name:name,resourceGroup:resourceGroup,loginServer:loginServer}" -o table
                    exit 1
                  fi
                fi

                if [ -z "$ACR_NAME" ]; then
                  echo "ERROR: No se encontró ACR en el resource group $(resourceGroup). Define 'acrName'."
                  exit 1
                fi

                if [ -z "$ACR_LOGIN_SERVER" ]; then
                  ACR_LOGIN_SERVER=$(az acr show -n "$ACR_NAME" --query loginServer -o tsv)
                fi

                if [ -z "$ACR_LOGIN_SERVER" ]; then
                  echo "ERROR: No se pudo resolver loginServer para ACR '$ACR_NAME'. Define 'acrLoginServer'."
                  exit 1
                fi

                echo "##vso[task.setvariable variable=acrName]$ACR_NAME"
                echo "##vso[task.setvariable variable=acrLoginServer]$ACR_LOGIN_SERVER"

                az acr login --name "$ACR_NAME"
                IMAGE="$ACR_LOGIN_SERVER/suma-proxy:$(Build.SourceVersion)"
                docker build -t "$IMAGE" .
                docker push "$IMAGE"
                docker tag "$IMAGE" "$ACR_LOGIN_SERVER/suma-proxy:latest"
                docker push "$ACR_LOGIN_SERVER/suma-proxy:latest"

                echo "##vso[task.setvariable variable=proxyImage;isOutput=true]$IMAGE"
            name: buildMeta

  - stage: DeployAKS
    displayName: 'Deploy to AKS'
    dependsOn: BuildAndPush
    jobs:
      - deployment: Deploy
        environment: 'aks-frontal'
        pool:
          vmImage: 'ubuntu-latest'
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self

                - task: AzureCLI@2
                  displayName: 'AKS deploy workloads'
                  inputs:
                    azureSubscription: '$(azureServiceConnection)'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      set -euo pipefail

                      ACR_LOGIN_SERVER="$(acrLoginServer)"

                      if [ -z "$ACR_LOGIN_SERVER" ]; then
                        ACR_NAME="$(acrName)"
                        if [ -z "$ACR_NAME" ]; then
                          ACR_NAME=$(az acr list -g "$(resourceGroup)" --query "[0].name" -o tsv)
                        fi

                        if [ -z "$ACR_NAME" ]; then
                          ACR_TOTAL=$(az acr list --query "length(@)" -o tsv)
                          if [ "$ACR_TOTAL" = "1" ]; then
                            ACR_NAME=$(az acr list --query "[0].name" -o tsv)
                          elif [ "$ACR_TOTAL" = "0" ]; then
                            echo "ERROR: No se encontró ningún ACR en la suscripción. Crea uno o define 'acrName'."
                            exit 1
                          else
                            echo "ERROR: Se encontraron múltiples ACR en la suscripción y ninguno en $(resourceGroup). Define 'acrName'."
                            az acr list --query "[].{name:name,resourceGroup:resourceGroup,loginServer:loginServer}" -o table
                            exit 1
                          fi
                        fi

                        if [ -z "$ACR_NAME" ]; then
                          echo "ERROR: No se encontró ACR en el resource group $(resourceGroup). Define 'acrName'."
                          exit 1
                        fi

                        ACR_LOGIN_SERVER=$(az acr show -n "$ACR_NAME" --query loginServer -o tsv)
                      fi

                      if [ -z "$ACR_LOGIN_SERVER" ]; then
                        echo "ERROR: No se pudo resolver 'acrLoginServer'."
                        exit 1
                      fi

                      az aks get-credentials -g "$(resourceGroup)" -n "$(aksClusterName)" --overwrite-existing

                      GHCR_PAT="$(ghcrPat)"

                      if [ -z "$GHCR_PAT" ]; then
                        GHCR_PAT=$(az keyvault secret show \
                          --vault-name "$(keyVaultName)" \
                          --name "github-pat" \
                          --query value -o tsv 2>/dev/null || true)
                      fi

                      if [ -z "$GHCR_PAT" ]; then
                        echo "ERROR: No se pudo obtener github-pat. Define variable secreta 'ghcrPat' en la pipeline o da permisos de secretos al service principal sobre Key Vault $(keyVaultName)."
                        exit 1
                      fi

                      kubectl apply -f k8s/namespace.yaml

                      kubectl create secret docker-registry ghcr-secret \
                        --namespace "$(namespace)" \
                        --docker-server=ghcr.io \
                        --docker-username="$(ghcrUser)" \
                        --docker-password="$GHCR_PAT" \
                        --dry-run=client -o yaml | kubectl apply -f -

                      kubectl apply -f k8s/backend-workloads.yaml
                      kubectl apply -f k8s/proxy-rbac.yaml

                      IMAGE="$ACR_LOGIN_SERVER/suma-proxy:$(Build.SourceVersion)"
                      sed "s|__PROXY_IMAGE__|$IMAGE|g" k8s/proxy-deployment.yaml | kubectl apply -f -
                      kubectl apply -f k8s/proxy-service.yaml

                      kubectl rollout status deployment/suma-proxy -n "$(namespace)" --timeout=300s
                      kubectl get deployments,services,pods -n "$(namespace)"
