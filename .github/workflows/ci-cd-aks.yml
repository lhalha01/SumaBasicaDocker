name: ci-cd-aks

on:
  push:
    branches: [ "FrontalSuma", "ConHelm", "master" ]
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  NAMESPACE: calculadora-suma
  TF_WORKING_DIR: infra/terraform
  GHCR_PAT_SECRET_NAME: github-pat

jobs:
  terraform-plan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Init
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform init

      - name: Terraform Validate
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform validate

      - name: Terraform Plan
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform plan -var="resource_group_name=${{ vars.AZURE_RESOURCE_GROUP }}" -var="existing_aks_name=${{ vars.AKS_CLUSTER_NAME }}" -var="kubelet_identity_object_id=${{ vars.AKS_KUBELET_OBJECT_ID }}"

  build-and-push:
    runs-on: ubuntu-latest
    needs: terraform-plan
    outputs:
      image: ${{ steps.meta.outputs.image }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ACR Login
        run: az acr login --name ${{ vars.ACR_NAME }}

      - name: Build and Push Proxy Image
        id: meta
        run: |
          IMAGE="${{ vars.ACR_LOGIN_SERVER }}/suma-proxy:${{ github.sha }}"
          docker build -t "$IMAGE" .
          docker push "$IMAGE"
          docker tag "$IMAGE" "${{ vars.ACR_LOGIN_SERVER }}/suma-proxy:latest"
          docker push "${{ vars.ACR_LOGIN_SERVER }}/suma-proxy:latest"
          echo "image=$IMAGE" >> "$GITHUB_OUTPUT"

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set AKS Context
        uses: azure/aks-set-context@v4
        with:
          resource-group: ${{ vars.AZURE_RESOURCE_GROUP }}
          cluster-name: ${{ vars.AKS_CLUSTER_NAME }}

      - name: Get GHCR PAT from Key Vault
        id: kv
        run: |
          GHCR_PAT=$(az keyvault secret show \
            --vault-name "${{ vars.AZURE_KEYVAULT_NAME }}" \
            --name "$GHCR_PAT_SECRET_NAME" \
            --query value -o tsv)
          echo "::add-mask::$GHCR_PAT"
          echo "ghcr_pat=$GHCR_PAT" >> "$GITHUB_OUTPUT"

      - name: Prepare Namespace and Secret
        run: |
          kubectl apply -f k8s/namespace.yaml
          kubectl create secret docker-registry ghcr-secret \
            --namespace $NAMESPACE \
            --docker-server=ghcr.io \
            --docker-username=${{ secrets.GHCR_USER }} \
            --docker-password=${{ steps.kv.outputs.ghcr_pat }} \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Deploy Backend and RBAC
        run: |
          kubectl apply -f k8s/backend-workloads.yaml
          kubectl apply -f k8s/proxy-rbac.yaml

      - name: Deploy Proxy
        run: |
          sed "s|__PROXY_IMAGE__|${{ needs.build-and-push.outputs.image }}|g" k8s/proxy-deployment.yaml | kubectl apply -f -
          kubectl apply -f k8s/proxy-service.yaml

      - name: Wait and Verify
        run: |
          kubectl rollout status deployment/suma-proxy -n $NAMESPACE --timeout=300s
          kubectl get deployments,services,pods -n $NAMESPACE
