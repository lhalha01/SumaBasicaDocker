grafana:
  enabled: true
  service:
    type: LoadBalancer
    port: 80
  persistence:
    enabled: false
  defaultDashboardsEnabled: true
  # adminPassword se inyecta en la pipeline via --set desde Key Vault

  dashboardProviders:
    dashboardproviders.yaml:
      apiVersion: 1
      providers:
        - name: suma-custom
          orgId: 1
          folder: Suma Calculadora
          type: file
          disableDeletion: false
          editable: true
          options:
            path: /var/lib/grafana/dashboards/suma-custom

  dashboards:
    suma-custom:
      suma-pods-ops:
        json: |-
          {
            "uid": "suma-pods-ops",
            "title": "Suma \u2014 Operaciones por N\u00famero de Pods",
            "tags": ["suma", "kubernetes"],
            "timezone": "browser",
            "schemaVersion": 38,
            "version": 1,
            "refresh": "30s",
            "panels": [
              {
                "id": 1,
                "type": "barchart",
                "title": "Operaciones totales por cantidad de pods usados (\u00faltimas 24h)",
                "gridPos": { "x": 0, "y": 0, "w": 12, "h": 9 },
                "datasource": { "type": "prometheus", "uid": "${datasource}" },
                "options": {
                  "orientation": "vertical",
                  "barWidth": 0.6,
                  "groupWidth": 0.7,
                  "xField": "pods",
                  "legend": { "displayMode": "list", "placement": "bottom" },
                  "tooltip": { "mode": "single" }
                },
                "fieldConfig": {
                  "defaults": {
                    "color": { "mode": "palette-classic" },
                    "custom": { "lineWidth": 1, "fillOpacity": 80 },
                    "unit": "short",
                    "displayName": "Operaciones"
                  }
                },
                "targets": [
                  {
                    "datasource": { "type": "prometheus", "uid": "${datasource}" },
                    "expr": "increase(suma_operaciones_total[24h])",
                    "legendFormat": "{{pods}} pod(s)",
                    "instant": true,
                    "refId": "A"
                  }
                ]
              },
              {
                "id": 2,
                "type": "timeseries",
                "title": "Operaciones acumuladas en el tiempo por n\u00b0 de pods",
                "gridPos": { "x": 12, "y": 0, "w": 12, "h": 9 },
                "datasource": { "type": "prometheus", "uid": "${datasource}" },
                "options": {
                  "legend": { "displayMode": "list", "placement": "bottom" },
                  "tooltip": { "mode": "multi" }
                },
                "fieldConfig": {
                  "defaults": {
                    "color": { "mode": "palette-classic" },
                    "unit": "short",
                    "custom": { "lineWidth": 2, "fillOpacity": 10 }
                  }
                },
                "targets": [
                  {
                    "datasource": { "type": "prometheus", "uid": "${datasource}" },
                    "expr": "suma_operaciones_total",
                    "legendFormat": "{{pods}} pod(s)",
                    "refId": "A"
                  }
                ]
              },
              {
                "id": 3,
                "type": "stat",
                "title": "Total operaciones (todas)",
                "gridPos": { "x": 0, "y": 9, "w": 6, "h": 4 },
                "datasource": { "type": "prometheus", "uid": "${datasource}" },
                "options": {
                  "colorMode": "background",
                  "graphMode": "area",
                  "reduceOptions": { "calcs": ["lastNotNull"] }
                },
                "fieldConfig": {
                  "defaults": { "color": { "mode": "thresholds" }, "unit": "short",
                    "thresholds": { "mode": "absolute",
                      "steps": [{"color": "green", "value": null}] } }
                },
                "targets": [
                  {
                    "datasource": { "type": "prometheus", "uid": "${datasource}" },
                    "expr": "sum(suma_operaciones_total)",
                    "legendFormat": "Total",
                    "instant": true,
                    "refId": "A"
                  }
                ]
              },
              {
                "id": 4,
                "type": "gauge",
                "title": "R\u00e9plicas activas de suma-proxy",
                "gridPos": { "x": 6, "y": 9, "w": 6, "h": 4 },
                "datasource": { "type": "prometheus", "uid": "${datasource}" },
                "options": {
                  "reduceOptions": { "calcs": ["lastNotNull"] },
                  "showThresholdLabels": false,
                  "showThresholdMarkers": true
                },
                "fieldConfig": {
                  "defaults": {
                    "unit": "short",
                    "min": 0,
                    "max": 4,
                    "thresholds": {
                      "mode": "absolute",
                      "steps": [
                        { "color": "blue", "value": null },
                        { "color": "green", "value": 1 },
                        { "color": "yellow", "value": 3 },
                        { "color": "red", "value": 4 }
                      ]
                    }
                  }
                },
                "targets": [
                  {
                    "datasource": { "type": "prometheus", "uid": "${datasource}" },
                    "expr": "kube_deployment_status_replicas_available{deployment=\"suma-proxy\", namespace=\"calculadora-suma\"}",
                    "legendFormat": "R\u00e9plicas",
                    "instant": true,
                    "refId": "A"
                  }
                ]
              },
              {
                "id": 5,
                "type": "timeseries",
                "title": "Latencia media por endpoint (ms)",
                "gridPos": { "x": 0, "y": 13, "w": 16, "h": 8 },
                "datasource": { "type": "prometheus", "uid": "${datasource}" },
                "options": {
                  "legend": { "displayMode": "list", "placement": "bottom" },
                  "tooltip": { "mode": "multi" }
                },
                "fieldConfig": {
                  "defaults": {
                    "color": { "mode": "palette-classic" },
                    "unit": "ms",
                    "custom": { "lineWidth": 2, "fillOpacity": 8 }
                  }
                },
                "targets": [
                  {
                    "datasource": { "type": "prometheus", "uid": "${datasource}" },
                    "expr": "1000 * rate(flask_http_request_duration_seconds_sum{path=~\"/suma-n-digitos|/docs-url|/grafana-url\"}[5m]) / rate(flask_http_request_duration_seconds_count{path=~\"/suma-n-digitos|/docs-url|/grafana-url\"}[5m])",
                    "legendFormat": "{{path}}",
                    "refId": "A"
                  }
                ]
              },
              {
                "id": 6,
                "type": "timeseries",
                "title": "Errores HTTP 5xx (tasa por segundo)",
                "gridPos": { "x": 16, "y": 13, "w": 8, "h": 8 },
                "datasource": { "type": "prometheus", "uid": "${datasource}" },
                "options": {
                  "legend": { "displayMode": "list", "placement": "bottom" },
                  "tooltip": { "mode": "multi" }
                },
                "fieldConfig": {
                  "defaults": {
                    "color": { "fixedColor": "red", "mode": "fixed" },
                    "unit": "reqps",
                    "custom": { "lineWidth": 2, "fillOpacity": 20 },
                    "thresholds": {
                      "mode": "absolute",
                      "steps": [
                        { "color": "green", "value": null },
                        { "color": "red", "value": 0.01 }
                      ]
                    }
                  }
                },
                "targets": [
                  {
                    "datasource": { "type": "prometheus", "uid": "${datasource}" },
                    "expr": "sum(rate(flask_http_request_total{status=~\"5..\"}[5m]))",
                    "legendFormat": "5xx req/s",
                    "refId": "A"
                  }
                ]
              }
            ],
            "templating": {
              "list": [
                {
                  "name": "datasource",
                  "type": "datasource",
                  "pluginId": "prometheus",
                  "current": {}
                }
              ]
            }
          }

  grafana.ini:
    server:
      root_url: "%(protocol)s://%(domain)s/"
    auth.anonymous:
      enabled: false
    dashboards:
      allow_ui_updates: true
      default_home_dashboard_path: ""
    users:
      allow_sign_up: false

prometheus:
  prometheusSpec:
    # Permite descubrir ServiceMonitors de cualquier namespace
    serviceMonitorSelectorNilUsesHelmValues: false
    serviceMonitorSelector: {}
    serviceMonitorNamespaceSelector: {}
    retention: 15d
    resources:
      requests:
        memory: 512Mi
        cpu: 250m
      limits:
        memory: 1Gi
        cpu: 500m

alertmanager:
  enabled: false

nodeExporter:
  enabled: true

kubeStateMetrics:
  enabled: true

# No necesitamos PVC persistente en entorno de lab
prometheusOperator:
  resources:
    requests:
      memory: 128Mi
      cpu: 100m
    limits:
      memory: 256Mi
      cpu: 200m
